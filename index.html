<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>360Â° Pano Comparison Viewer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    .comparison-container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    #panoA, #panoB {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    #panoA { z-index: 1; }
    #panoB { z-index: 2; }
    #sliderContainer {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      width: 300px;
      background: rgba(0,0,0,0.5);
      padding: 10px;
      border-radius: 10px;
    }
    input[type="range"] {
      width: 100%;
    }
    #fileInput {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 20px;
      border-radius: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="comparison-container">
    <div id="panoA"></div>
    <div id="panoB"></div>
    <div id="sliderContainer"><input type="range" id="slider" min="0" max="100" value="50"></div>
    <input type="file" id="fileInput" multiple accept="image/*">
    <div id="loading">Loading panoramas...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const slider = document.getElementById('slider');
    const panoAContainer = document.getElementById('panoA');
    const panoBContainer = document.getElementById('panoB');
    const loading = document.getElementById('loading');

    let panoA, panoB, urls = [];

    function showLoading(state) {
      loading.style.display = state ? 'block' : 'none';
    }

    function setClip(val) {
      panoBContainer.style.width = `${val}%`;
    }

    function syncViewers() {
      let syncing = false;
      const sync = (source, target) => {
        if (syncing) return;
        syncing = true;
        target.setYaw(source.getYaw());
        target.setPitch(source.getPitch());
        target.setHfov(source.getHfov());
        setTimeout(() => syncing = false, 10);
      };

      [ [panoA, panoB], [panoB, panoA] ].forEach(([a, b]) => {
        ['load', 'zoomchange', 'mousemove', 'touchmove', 'mousedown'].forEach(evt =>
          a.on(evt, () => sync(a, b))
        );
      });
    }

    function loadPanoramas([img1, img2]) {
      if (panoA) panoA.destroy();
      if (panoB) panoB.destroy();

      showLoading(true);

      const view = { yaw: 0, pitch: 0, hfov: 100 };

      panoA = pannellum.viewer('panoA', {
        type: 'equirectangular',
        panorama: img1,
        autoLoad: true,
        showControls: false,
        mouseZoom: false,
        keyboardZoom: false,
        ...view
      });

      panoB = pannellum.viewer('panoB', {
        type: 'equirectangular',
        panorama: img2,
        autoLoad: true,
        showControls: false,
        mouseZoom: false,
        keyboardZoom: false,
        ...view
      });

      let loaded = 0;
      const onLoaded = () => {
        if (++loaded === 2) {
          panoB.setYaw(panoA.getYaw());
          panoB.setPitch(panoA.getPitch());
          panoB.setHfov(panoA.getHfov());
          setClip(slider.value);
          syncViewers();
          showLoading(false);
        }
      };

      panoA.on('load', onLoaded);
      panoB.on('load', onLoaded);
    }

    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files).slice(0, 2); // Use only first two
      if (files.length < 1) return;

      urls.forEach(u => URL.revokeObjectURL(u)); // Clean old
      urls = files.map(f => URL.createObjectURL(f));

      if (urls.length === 1) {
        panoA = pannellum.viewer('panoA', {
          type: 'equirectangular',
          panorama: urls[0],
          autoLoad: true,
          showControls: true
        });
        panoBContainer.style.display = 'none';
        document.getElementById('sliderContainer').style.display = 'none';
      } else {
        panoBContainer.style.display = 'block';
        document.getElementById('sliderContainer').style.display = 'block';
        loadPanoramas(urls);
      }
    });

    slider.addEventListener('input', e => setClip(e.target.value));
    window.addEventListener('beforeunload', () => urls.forEach(u => URL.revokeObjectURL(u)));
  </script>
</body>
</html>
